<!--
  templateType: page
  isAvailableForNewContent: true
  label: Hubdb template
-->
{% extends "./layouts/base-members.html" %}
{% import "../macros/tags.html" as c %}

{% block body %}
	{% if dynamic_page_hubdb_row %}
		{% set d = dynamic_page_hubdb_row %}
		<section class="content-area">
			<div class="main-content">
				<!-- Rewards -->
				<section class="rewards-details">
					<div class="breadcrumb">
						<div class="breadcrumb__item">
							<a style="color: #fff; text-decoration: none" href="{{ '/'~(request.path|split('/'))[0] }}">
								{% if currLang == 'zh-cn' %}
									 奖励
								{% else %}
									Rewards
								{% endif %}
							</a>
						</div>
						{{ c.chevron_right() }}
						<div class="breadcrumb__item">
							{{ (d.categories|first).name }}
						</div>
						{{ c.chevron_right() }}
						<div class="breadcrumb__item active">
						{% if currLang == 'zh-cn' %}
							{{ d.name_chinese }}
						{% else%}
							{{ d.name }}
						{% endif %}
						</div>
					</div>
					<!-- End of breadcrumb -->

					<div class="content-row">
						<div class="content-col">
							<h2 class="post-title">
								{% if currLang == 'zh-cn' %}
									{{ d.name_chinese }}
								{% else%}
									{{ d.name }}
								{% endif %}
							</h2>
							<div>
								{% if currLang == 'zh-cn' %}
									{{ d.content_chinese }}
								{% else %}
									{{ d.content }}
								{% endif %}
							</div>

							<p class="tier-availability">{{ currLang == 'zh-cn' ? '适用于' : 'Available for' }} : {{ d.member_tier_availability|map('name')|join(', ') }}</p>
							{% if d.show_stock_count %}
								{{ currLang == 'zh-cn' ? '股票' : 'Stock' }}: {{ d.stock }}
							{% endif %}

							{% if d.stock <= 0 %}
								{% set class_name = 'clr-mute' %}
								{% set label = 'Fully Redeemed' %}
							{% endif%}

							{% if contact.current_loyalty_points < d.point %}
								{# {{ contact.current_loyalty_points < d.point  }} #}
								{% set class_name = 'clr-mute' %}
								{% set label = 'Insufficient Z Points' %}
							{% endif %}

							{% if  contact.current_loyalty_points > d.point && d.stock > 0 %}
								{% set class_name = '' %}
								{% set label = 'Available' %}
							{% endif %}
							<div class="cta-container">
								<div class="availability {{ class_name }}">
									{{ label  }}
								</div>

								<div class="dfl cta">
									<div>
										<span class="fs-large">{{ d.point }}</span>
										<span class="fs-sm">Z Points</span>
									</div>

									<div>
										<a
											href="#"
											data-modal-target="modal-redemption"
											class="button button--primary "
												{{ d.stock > 0 && contact.current_loyalty_points > d.point || 'disabled' }}
											>
											{{ d.stock > 0 && contact.current_loyalty_points > d.point ? 'Redeem Now' : 'Unavailable' }}
										</a>
									</div>
								</div>
							</div>

							<div class="fs-sm toc">
								{% if currLang == 'zh-cn' %}
									{{ d.tnc_chinese }}
								{% else%}
									{{ d.tnc }}
								{% endif %}
							</div>
						</div>

						<div class="content-col">
							<img src="{{ d.image.url }}" alt="" />
						</div>
					</div>
				</section>
			</div>
		</section>

		{# Modal #}
		{% call c.modal('modal-redemption', 'lg') %}
			<div class="form-container anim" style="padding-top: 30px">
				{% form "redemption_form" form_to_use='72dcb3b7-6292-492c-a1c1-b902c41704cd' %}
			</div>
		{% endcall %}

	{% elif dynamic_page_hubdb_table_id %}
		<section class="content-area">
			<div class="main-content">
				<!-- Rewards -->
				<section class="rewards">
					<div class="dfl fl-j-sb fl-a-c">
						<form action="" class="rewards__filter">
							<div class="fields">
								<div class="field">
									<label for="id-categories" class="fs-sm"
										>Categories</label
									>
									<select name="" id="id-categories">
										<option value="all" class="selected disabled"
											>All</option
										>
										<option value="1">Others</option>
										<option value="2">Gadgets</option>
									</select>
								</div>

								<div class="field">
									<label for="id-points" class="fs-sm"
										>Z Points</label
									>
									<select name="" id="id-points">
										<option value="all" class="selected disabled"
											>All</option
										>
										<option value="<1000">&lt; 1000</option>
										<option value="1001-7000">1001 - 7000</option>
										<option value=">7000">&gt; 7000</option>
									</select>
								</div>
							</div>
						</form>
					</div>
					<div class="grids">
						{% if request.query_dict.categories %}
							{% set q_cat = 'categories__icontains='~request.query_dict.categories %}
						{% else %}
							{% set q_cat = '' %}
						{% endif %}


						{% for row in hubdb_table_rows(dynamic_page_hubdb_table_id, q_cat) %}
							{{ c.reward_card(row) }}
						{% endfor %}
					</div>
					{# End of Grids #}
				</section>
			</div>
		</section>
	{% endif %}

	<script>
		const rowId = "{{ dynamic_page_hubdb_row.hs_id }}"

		window.addEventListener('message', event => {
			if(event.data.type === 'hsFormCallback' && event.data.eventName === 'onFormReady') {
					const $redeemInput = document.querySelector('input[name="last_redeemed_id"]')
					const $redeemItemName = document.querySelector('input[name="last_redeemed_item_name"]')

					$redeemInput.value = "{{ dynamic_page_hubdb_row.hs_id }}";
					$redeemItemName.value = "{{ dynamic_page_hubdb_row.name }}"
			}
		});
	</script>

{% endblock body %}
