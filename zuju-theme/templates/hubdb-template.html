<!--
  templateType: page
  isAvailableForNewContent: true
  label: Hubdb template
-->
{% extends "./layouts/base-members.html" %}
{% import "../macros/tags.html" as c %}
{{ require_css('https://cdn.jsdelivr.net/npm/@splidejs/splide@3.1.6/dist/css/splide.min.css', 'header') }}

{% block body %}
	{% if dynamic_page_hubdb_row %}
		{% set d = dynamic_page_hubdb_row %}
		<section class="content-area">
			<div class="main-content">
				<!-- Rewards -->
				<section class="rewards-details">
					<div class="breadcrumb">
						<div class="breadcrumb__item">
							<a href="{{ '/'~(request.path|split('/'))[0] }}">
								{% if currLang == 'zh-cn' %}
									 奖励
								{% else %}
									Rewards
								{% endif %}
							</a>
						</div>
						<div class="breadcrumb__item">
							{{ c.chevron_right() }}
							{{ c.categories((d.categories|first).name) }}
						</div>
						<div class="breadcrumb__item active">
							{{ c.chevron_right() }}

							{% if currLang == 'zh-cn' %}
								{{ d.name_chinese }}
							{% else%}
								{{ d.name }}
							{% endif %}
						</div>
					</div>
					<!-- End of breadcrumb -->

					<div class="content-row">
						<div class="content-col">
							<h2 class="post-title">
								{% if currLang == 'zh-cn' %}
									{{ d.name_chinese }}
								{% else%}
									{{ d.name }}
								{% endif %}
							</h2>
							<div>
								{% if currLang == 'zh-cn' %}
									{{ d.content_chinese }}
								{% else %}
									{{ d.content }}
								{% endif %}
							</div>

							<p class="tier-availability">
								{{ currLang == 'zh-cn' ? '适用于' : 'Available for' }} : {{ d.member_tier_availability|map('name')|join(', ') }}
							</p>

							{% if d.show_stock_count %}
								{{ currLang == 'zh-cn' ? '股票' : 'Stock' }}: {{ d.stock }}
							{% endif %}

							{% if d.stock <= 0 %}
								{% set class_name = 'clr-mute' %}
								{% set label = 'Fully Redeemed' %}
							{% endif%}

							{% if contact.current_loyalty_points < d.point %}
								{# {{ contact.current_loyalty_points < d.point  }} #}
								{% set class_name = 'clr-mute' %}
								{% set label = '{{ currLang == "zh-cn" ? "Z积分不足" : "Insufficient Z Points" }}' %}
							{% endif %}

							{% if  contact.current_loyalty_points > d.point && d.stock > 0 %}
								{% set class_name = '' %}
								{% set label = 'Available' %}
							{% endif %}
							<div class="cta-container">
								<div class="availability {{ class_name }}">
									{{ label  }}
								</div>

								<div class="dfl cta">
									<div>
										<span class="fs-large">{{ d.point|format_currency('en-US')|replace('$', '') }}</span>
										<span class="fs-sm">{{ currLang == "zh-cn" ? "Z积分" : "Z Points" }}</span>
									</div>

									<div>
										<button
											data-modal-target="modal-redemption"
											class="button button--primary "
												{{ d.stock|int > 0 && contact.current_loyalty_points|int > d.point|int || 'disabled' }}
											>
                      {% if currLang == 'zh-cn' %}
											  {{ (d.stock|int > 0 && contact.current_loyalty_points|int > d.point|int) ? 'Redeem Now' : '无法使用' }}
                      {% else %}
                        {{ (d.stock|int > 0 && contact.current_loyalty_points|int > d.point|int) ? 'Redeem Now' : 'Unavailable' }}
                      {% endif %}
										</button>
									</div>
								</div>
							</div>

							<div class="fs-sm toc">
								{% if currLang == 'zh-cn' %}
									{{ d.tnc_chinese }}
								{% else%}
									{{ d.tnc }}
								{% endif %}
							</div>
						</div>

						<div class="content-col">
							<div class="splide rewards-carousel">
								<div class="splide__arrows">
									<button class="splide__arrow splide__arrow--prev">
										<svg width="32px" height="32px" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
											<g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
													<g id="zuju/members-portal/rewards-details" transform="translate(-1518.000000, -674.000000)">
															<g id="Group-2" transform="translate(1518.000000, 674.000000)">
																	<rect id="Rectangle" fill="#ED2938" x="0" y="0" width="32" height="32"></rect>
																	<path d="M19.8312146,15.9999629 L12.979811,9.16750932 C12.7553328,8.94378329 12.3918973,8.94415939 12.1677952,9.16866657 C11.9438666,9.39314482 11.9444452,9.7567828 12.1689524,9.98068242 L18.6125399,16.4064771 L12.168721,22.8322428 C11.9442427,23.0561714 11.9436641,23.4195779 12.1675637,23.6440851 C12.2799041,23.756628 12.4270778,23.8128994 12.5742515,23.8128994 C12.7210491,23.8128994 12.8676442,23.7570041 12.9797821,23.6452423 L19.8312146,16.8129624 C19.939331,16.7053957 20,16.5590031 20,16.4064771 C20,16.2539511 19.9391574,16.1077321 19.8312146,15.9999629 Z" id="Path" fill="#FFFFFF" fill-rule="nonzero" transform="translate(16.000000, 16.406450) scale(-1, 1) rotate(-180.000000) translate(-16.000000, -16.406450) "></path>
															</g>
													</g>
											</g>
										</svg>
									</button>

									<button class="splide__arrow splide__arrow--next">
										<svg width="32px" height="32px" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
											<g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
													<g id="zuju/members-portal/rewards-details" transform="translate(-1518.000000, -674.000000)">
															<g id="Group-2" transform="translate(1518.000000, 674.000000)">
																	<rect id="Rectangle" fill="#ED2938" x="0" y="0" width="32" height="32"></rect>
																	<path d="M19.8312146,15.9999629 L12.979811,9.16750932 C12.7553328,8.94378329 12.3918973,8.94415939 12.1677952,9.16866657 C11.9438666,9.39314482 11.9444452,9.7567828 12.1689524,9.98068242 L18.6125399,16.4064771 L12.168721,22.8322428 C11.9442427,23.0561714 11.9436641,23.4195779 12.1675637,23.6440851 C12.2799041,23.756628 12.4270778,23.8128994 12.5742515,23.8128994 C12.7210491,23.8128994 12.8676442,23.7570041 12.9797821,23.6452423 L19.8312146,16.8129624 C19.939331,16.7053957 20,16.5590031 20,16.4064771 C20,16.2539511 19.9391574,16.1077321 19.8312146,15.9999629 Z" id="Path" fill="#FFFFFF" fill-rule="nonzero" transform="translate(16.000000, 16.406450) scale(-1, 1) rotate(-180.000000) translate(-16.000000, -16.406450) "></path>
															</g>
													</g>
											</g>
										</svg>
									</button>
								</div>
								<div class="splide__track">
									<ul class="splide__list">
										{% if d.image %}
											<li class="splide__slide">
												<img src="{{ d.image.url }}" alt="{{ d.name }}" />
											</li>
										{% endif %}

										{% if d.image2 %}
											<li class="splide__slide">
												<img src="{{ d.image2.url }}" alt="" />
											</li>
										{% endif %}

										{% if d.image3 %}
											<li class="splide__slide">
												<img src="{{ d.image3.url }}" alt="" />
											</li>
										{% endif %}
									</ul>
								</div>
							</div>
						</div>
					</div>
				</section>
			</div>
		</section>

		{# Modal #}
		{% call c.modal('modal-redemption', 'lg') %}
			<div class="form-container anim" style="padding-top: 30px">
				{% form "redemption_form" form_to_use='72dcb3b7-6292-492c-a1c1-b902c41704cd' %}
			</div>
		{% endcall %}

	{% elif dynamic_page_hubdb_table_id %}
		<section class="content-area">
			<div class="main-content">
				<!-- Rewards -->
				<section class="rewards">
					<div class="dfl fl-j-sb fl-a-c">
						<form action="" class="rewards__filter">
							<div class="fields">
								<div class="field">
									{% set categories = [
										{
											id: 'one',
											value: 'CR7 MEMORABILIA',
										}, {
											id: 'two',
											value: 'ELECTRONICS'
										}, {
											id: 'three',
											value: 'CR7 EXPERIENCES'
										}, {
											id: 'four',
											value: 'GIFT CARDS'
										}
									] %}

									{% set points = [{
											id: 1,
											value: '<1000'
										}, {
											id: 2,
											value: '1001 - 7000'
										}, {
											id: 3,
											value: '>7000'
										}
									] %}

									{% set qCat = request.query_dict['categories']|default('') %}
									{% set qPts = request.query_dict['points']|default('') %}

									{% if qCat %}
										{% set catFilter = 'categories__in='~qCat %}
									{% endif %}

									{% if qPts %}
										{% if qPts == 1 %}
											{% set ptsFilter = '&point__lte=1000' %}
										{% elif qPts == 2 %}
											{% set ptsFilter = '&point__lte=7000&point__gt=1000' %}
										{% elif qPts == 3 %}
											{% set ptsFilter = '&point__gt=7000' %}
										{% else %}
											{% set ptsFilter = '' %}
										{% endif %}
									{% endif %}


									{% set reward_categories = {
											'en': [
												{
													id: 'one',
													value: 'CR7 MEMORABILIA',
												}, {
													id: 'two',
													value: 'ELECTRONICS'
												}, {
													id: 'three',
													value: 'CR7 EXPERIENCES'
												}, {
													id: 'four',
													value: 'GIFT CARDS'
												}
											],
											'zh-cn': [
												{
													id: 'one',
													value: '电子产品',
												}, {
													id: 'two',
													value: 'C罗相关纪念奖'
												}, {
													id: 'three',
													value: 'C罗相关体验奖'
												}, {
													id: 'four',
													value: '礼品卡'
												}
											]
										}
									%}

									{% macro categories(category_id) %}
										{{ (reward_categories['zh-cn']|selectattr('id', 'equalto', category_id)|first).value }}
									{% endmacro %}

									<label for="id-categories" class="fs-sm">{{ currLang == 'zh-cn' ? '类别' :  'Categories' }}</label>
									<select name="" id="id-categories">
										<option value="" selected>{{ currLang == 'zh-cn' ? '全部' : 'All' }}</option>

										{% for category in reward_categories[html_lang] %}
											<option value="{{ category.id }}" {{ qCat == category.id ? 'selected' : '' }}>{{ category.value }}</option>
										{% endfor %}
									</select>
								</div>

								<div class="field">
									<label for="id-points" class="fs-sm">{{ currLang == 'zh-cn' ? 'Z积分' : 'Z Points' }}</label>
									<select name="" id="id-points">
										<option value="" selected>{{ currLang == 'zh-cn' ? '全部' : 'All' }}</option>

										{% for point in points %}
											<option value="{{ point.id }}" {{ 'selected' if point.id == qPts }}>{{ point.value }}</option>
										{% endfor %}
									</select>
								</div>
							</div>
						</form>
					</div>
					<div class="grids">
						{% for row in hubdb_table_rows(dynamic_page_hubdb_table_id, catFilter~ptsFilter) %}
							{{ c.reward_card(row) }}
						{% endfor %}
					</div>
					{# End of Grids #}
				</section>
			</div>
		</section>
	{% endif %}

	<script>
		const rowId = "{{ dynamic_page_hubdb_row.hs_id }}"

		window.addEventListener('message', event => {
			if(event.data.type === 'hsFormCallback' && event.data.eventName === 'onFormReady') {
					const $redeemInput = $('input[name="last_redeemed_id"]')
					const $redeemItemName = $('input[name="last_redeemed_item_name"]')

					$redeemInput.val("{{ dynamic_page_hubdb_row.hs_id }}");
					$redeemItemName.val("{{ dynamic_page_hubdb_row.name }}");
			}
		});
	</script>

	{{ require_js('https://cdn.jsdelivr.net/npm/@splidejs/splide@3.1.6/dist/js/splide.min.js', 'footer') }}

	{% require_js %}
		<script>
			$(document).ready(function() {
				const splide = new Splide('.splide', { pagination: false, heightRatio: .7 })
				splide.on( 'mounted', function (a, b, c) {

					if (splide.length <= 1)  {
						{# console.log(splide.Components.Arrows.destroy()) #}
						{# splide.options.arrows = false #}
						$('.splide__arrows').hide()
					}
				});
				splide.mount()
			});
		</script>
	{% end_require_js %}
{% endblock body %}
